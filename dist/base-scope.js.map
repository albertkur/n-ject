{"version":3,"file":"base-scope.js","sourceRoot":"","sources":["../src/base-scope.ts"],"names":[],"mappings":"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","sourcesContent":["import given from \"n-defensive\";\nimport Scope from \"./scope\";\nimport ScopeType from \"./scope-type\";\nimport Lifestyle from \"./lifestyle\";\nimport \"n-ext\";\nimport { ApplicationException, InvalidOperationException } from \"n-exception\";\nimport ComponentRegistry from \"./component-registry\";\nimport ComponentRegistration from \"./component-registration\";\n\n// internal\nabstract class BaseScope implements Scope\n{\n    private readonly _scopeType: ScopeType;\n    private readonly _componentRegistry: ComponentRegistry;\n    private readonly _parentScope: Scope;\n    private readonly _scopedInstanceRegistry: {[index: string]: object} = {};\n    private _isBootstrapped = false;\n\n\n    public get scopeType(): ScopeType { return this._scopeType; }\n    protected get componentRegistry(): ComponentRegistry { return this._componentRegistry; }\n    protected get isBootstrapped(): boolean { return this._isBootstrapped; }\n\n\n    protected constructor(scopeType: ScopeType, componentRegistry: ComponentRegistry, parentScope: Scope)\n    {\n        given(scopeType, \"scopeType\").ensureHasValue();\n        given(componentRegistry, \"componentRegistry\").ensureHasValue();\n        given(parentScope, \"parentScope\")\n            .ensure(t => scopeType === ScopeType.Child ? parentScope != null : parentScope == null,\n            \"cannot be null if scope is a child scope and has to be null if scope is root scope\");\n\n        this._scopeType = scopeType;\n        this._componentRegistry = componentRegistry;\n        this._parentScope = parentScope;\n    }\n\n\n    public resolve<T extends object>(key: string): T\n    {\n        if (!this.isBootstrapped)\n            throw new InvalidOperationException(\"resolve\");    \n        \n        given(key, \"key\").ensureHasValue().ensure(t => !t.isEmptyOrWhiteSpace());\n\n        key = key.trim();\n        let registration = this._componentRegistry.find(key);\n        if (!registration)\n            throw new ApplicationException(\"No component with key '{0}' registered.\".format(key));\n\n        return this.findInstance(registration) as T;\n    }\n    \n    protected bootstrap(): void\n    {\n        this._isBootstrapped = true;\n    }\n\n    private findInstance(registration: ComponentRegistration): object\n    {\n        if (registration.lifestyle === Lifestyle.Singleton)\n        {\n            if (this.scopeType === ScopeType.Child)\n                return this._parentScope.resolve(registration.key);\n            else\n                return this.findScopedInstance(registration);\n        }\n        else if (registration.lifestyle === Lifestyle.Scoped)\n        {\n            if (this.scopeType === ScopeType.Root)\n                throw new ApplicationException(\"Cannot resolve component '{0}' with scoped lifestyle from root scope.\"\n                    .format(registration.key));\n            else\n                return this.findScopedInstance(registration);\n        }\n        else\n        {\n            return this.createInstance(registration);\n        }\n    }\n\n    private findScopedInstance(registration: ComponentRegistration): object\n    {\n        if (this._scopedInstanceRegistry[registration.key])\n            return this._scopedInstanceRegistry[registration.key];\n        else\n        {\n            let instance = this.createInstance(registration);\n            this._scopedInstanceRegistry[registration.key] = instance;\n            return instance;\n        }\n    }\n\n    private createInstance(registration: ComponentRegistration): object\n    {\n        let dependencyInstances = [];\n        for (let dependency of registration.dependencies)\n        {\n            let dependencyRegistration = this._componentRegistry.find(dependency);\n            if (!dependencyRegistration)\n                throw new ApplicationException(\"Dependency '{0}' of component '{1}' not registered.\"\n                    .format(dependency, registration.key));\n\n            dependencyInstances.push(this.findInstance(dependencyRegistration));\n        }\n        return new (<any>registration.component)(...dependencyInstances);\n    }\n}\n\nexport default BaseScope;"]}